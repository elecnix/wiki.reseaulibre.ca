[[!waypoint lat="45.465676" lon="-73.572185" embed hidden width="400px" height="400px" right desc="Bullet 15 dbi sur le mat de mon voisin."]]

# Détails techniques

[[!ymlfront data="""
MAC: DC:9F:DB:01:13:79
IP: ..
IPv6: ..
"""]]

 * hostname: latakia
 * MAC address: {{$MAC}}
 * IPv6 address: {{$IPv6}}
 * Link-local IPv6 address: n/a (wlan0), fe80::de9f:dbff:fe01:1379 (eth0), 2607:f2c0:f00f:2910:de9f:dbff:fe01:1379/64 (eth0)
 * IP address: {{$IP}}
 * Software: OpenWRT (attitude adjustment) Trunk 2012-07-26
 * Hardware: Ubiquity NanoStation M2
 * Power: 28dBm
 * Location: dans une fenêtre au 3e étage
 * Azimuth: 120°
 * Panorama: N/A
 * Status: [[!taglink up]]
 * Operator: [[users/bgm]]
 * Links: [[deuxpi]] (10mbps), [[bgm-homs]] (ethernet), [[bgm-alep]] (ethernet)

# Photo

[[!img img/557254_529308290429346_1820250233_n.jpg alt="Bullet M2"]]

# UCI

    # base
    uci delete wireless.radio0.disabled
    uci set wireless.@wifi-iface[0].ssid=reseaulibre.ca
    uci set system.@system[0].hostname=latakia

    # connexion réseau local
    uci set network.lan=interface
    uci set network.lan.ifname=eth0
    uci set network.lan.proto=dhcp

    # wifi
    uci delete wireless.@wifi-iface[0].network
    uci set wireless.radio0.channel=1
    uci set wireless.@wifi-iface[0].mode=adhoc
    uci set wireless.@wifi-iface[0].ssid=reseaulibre.ca
    uci set wireless.@wifi-iface[0].bssid=02:CA:FF:EE:BA:BE
    uci set network.wlan0=interface
    uci set network.wlan0.ifname=wlan0
    uci set network.wlan0.proto=none
    uci set network.wlan0.mtu=1528
    
    # packages pour batman et babel
    opkg update
    opkg install kmod-ipv6 kmod-batman-adv babeld

    #batman
    uci set network.bat0=interface
    uci set network.bat0.ifname=bat0
    uci set network.bat0.proto=none
    uci set network.bat0.mtu=1500
    
    uci set network.bat0.ipaddr=172.16.1.42
    uci set network.bat0.proto=static
    uci set network.bat0.netmask=255.255.0.0
    
    uci set batman-adv.bat0.interfaces="wlan0"
    uci commit
    reboot
    

    # ipv6
    uci set radvd.@interface[0]=interface
    uci set radvd.@interface[0].interface=wifi
    uci set radvd.@interface[0].AdvSendAdvert=1
    uci set radvd.@interface[0].client=
    uci set radvd.@interface[0].AdvManagedFlag=1
    uci set radvd.@interface[0].AdvOtherConfigFlag=1
    uci set radvd.@interface[0].ignore=0
    uci set radvd.@prefix[0]=prefix
    uci set radvd.@prefix[0].interface=wifi
    uci set radvd.@prefix[0].AdvOnLink=1
    uci set radvd.@prefix[0].AdvAutonomous=1
    uci set radvd.@prefix[0].ignore=0
    uci set radvd.@route[0]=route
    uci set radvd.@route[0].interface=wifi
    uci set radvd.@route[0].prefix=2607:f2c0:f00f:29a2::/64
    uci set radvd.@route[0].ignore=0
    uci set radvd.@rdnss[0]=rdnss
    uci set radvd.@rdnss[0].interface=wifi
    uci set radvd.@rdnss[0].addr=2607:f2c0:f00f:2900::1
    uci set radvd.@dnssl[0]=dnssl
    uci set radvd.@dnssl[0].interface=wifi
    uci set radvd.@dnssl[0].suffix=net4.bidon.ca

# Configuration babel

Topologie:

    [routeur principal "damas"]  => [routeur tplink MR3420 voisinage "alep"] => [nanostation "homs"] => [bullet "latakia"]
     2607:f2c0:f00f:2900::/56
    
                                                                              => [wifi] 2607:f2c0:f00f:29a5::/64
    
                                                                              => [routeur dlink voisins] => [lan voisins]

                                 => [desktops/laptops câblés] 2607:f2c0:f00f:2910::/64
                                 


## Routeur principal "damas" (Debian)

    interface eth1 wired true
    redistribute local proto 2 ip 2607:f2c0:f00f:2900::1/56 le 56

    # refuse anything else not explicitely allowed
    redistribute local deny
    redistribute deny

IMPORTANT: 2607:f2c0:f00f:2900::1/56 doit être assigné à une interface réseau, pour que la route existe. C'est équivalent à 2607:f2c0:f00f:2900::/56, mais on ne peut pas assigner ça à une interface réseau. Initialement j'avais 2607:f2c0:f00f:2900::1/128 (= damas.net4.bidon.ca).

    ip -f inet6 addr del 2607:f2c0:f00f:2900::1/128 dev eth0
    ip -f inet6 addr add 2607:f2c0:f00f:2900::1/56 dev eth0

Configurer ça comme ça permet d'exporter une seule entrée pour tout mon réseau.

## Routeur voisinage "alep" (OpenWRT)

    babeld.@general[0]=general
    babeld.@general[0].local_server=33123
    babeld.@filter[0]=filter
    babeld.@filter[0].type=redistribute
    babeld.@filter[0].local=true
    babeld.@filter[0].action=deny
    babeld.@filter[1]=filter
    babeld.@filter[1].type=redistribute
    babeld.@filter[1].action=deny
    babeld.eth1=interface
    babeld.eth0=interface

i.e. on écoute sur les interfaces câblées, et on ne redistribue pas de routes. Ça va relayer celle de 'damas' automatiquement.
Ce routeur a du wifi (wlan0), mais c'est du WPA2 pour les visiteurs, ce n'est pas un AP ouvert, donc pas besoin d'y rouler babel.

## Routeur nanostation "homs" (OpenWRT)

    babeld.@general[0]=general
    babeld.@general[0].local_server=33123
    babeld.@filter[0]=filter
    babeld.@filter[0].type=redistribute
    babeld.@filter[0].local=true
    babeld.@filter[0].action=deny
    babeld.@filter[1]=filter
    babeld.@filter[1].type=redistribute
    babeld.@filter[1].action=deny
    babeld.wlan0=interface
    babeld.eth0=interface
    babeld.eth1=interface

Ici on utilise les 3 interfaces, car eth0 connecte à "latakia" (bullet), eth1 à "alep" (vers le réseau local) et le wlan0 connecte à hexa en mode adhoc.

## Routeur nanostation "latakia" (OpenWRT)

    babeld.@general[0]=general
    babeld.@general[0].local_server=33123
    babeld.@filter[0]=filter
    babeld.@filter[0].type=redistribute
    babeld.@filter[0].local=true
    babeld.@filter[0].action=deny
    babeld.@filter[1]=filter
    babeld.@filter[1].type=redistribute
    babeld.@filter[1].action=deny
    babeld.wlan0=interface
    babeld.eth0=interface

Fin de la chaîne.. wlan0 connecte à deuxpi par adhoc, eth0 connecte à "homs" (bullet).

# Notes

* Comment crimper avec les connecteurs "Tough cable": http://www.ubnt.com/downloads/datasheets/toughcable/TOUGHCable_Datasheet.pdf
