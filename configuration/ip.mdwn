[[!meta title="Internet protocols configuration"]]
[[!meta description="Includes information about IP addresses, IPv6 and routing"]]

[[!toc levels=3]]

# IP allocation strategy

IP addresses are allocated on a first come first serve basis. We
strongly encourage clever use of IPv6 to avoid starvation.

This section documents the strategy and the addresses already allocated. To configure your device, see the next section, but please update the information below when you allocate yourself an IP.

## IPv4

[[!table class="pagecloud" data="""
IP | Hardware | wifi MAC | Location
172.16.0.1   | Soekris        | N/A | [[nodes/roadkiller]]
172.16.0.2 | Bullet M2 #2 | 00:15:6d:db:d3:65 | [[nodes/boulette]]
172.16.0.3 | Server | N/A  | nexus.coeus.ca
172.16.0.4 | Bullet M2 #1 | 00:15:6D:DB:D3:DC | [[nodes/benoitg]]
172.16.0.5 | Bullet M2 #2 | TBD | TBD]
172.16.1.1 | Linksys WRT54G | 00:1C:10:22:02:AE | [[nodes/carton]]
172.16.1.2 | NanoStation M2 | 00:15:6D:71:37:26 | [[nodes/ouaibe]]
172.16.1.3 | Linksys WRT54G | 00:25:9c:5e:44:59 | elecnix/grace
172.16.1.4 | Linksys WRT54G | 00:13:10:1b:6d:dd | elecnix/pierre

192.168.3.92 | PicoStation M2 | 00:15:6d:81:e0:5b
192.168.3.93 | NanoStation M2 | 00:15:6d:fc:be:90
192.168.3.94 | NanoBridge | 00:15:6d:5a:f7:27
"""]]

The proper allocation for new IPs is in the `172.16.0.0/12` private B
class (from [[!rfc 1918]]). `172.16.0.X/24` is reserved for big
interconnects (like [[nodes/boulette]]), so if you have just a node in
your window, using `172.16.1.X/24` for now (like [[nodes/carton]]).

> (!) We are on the process of migrating away from the
> `192.168.3.0/24` netblock, which was too small for our needs and
> only used informally during the
> [[first setup|meetings/2012-04-06-antenna-party]]. See also the
> [[discussion]] page for a rationale.
  
> (!) Note: the table on the right is manually maintained and may fall out of sync with the data in [[nodes]]. We are looking forward towards [support for aggregating definition lists in ikiwiki](http://ikiwiki.info/todo/internal_definition_list_support/) (and if people are interested on working on this it would be great), but in the meantime this is error-prone...

## IPv6

We are using a huge IPv6 space (a `/48`, which allows for 65,536 `/64` networks) known as ULA (see below) for our mesh. The global prefix (`fd64:2c08:9fa7::/48`) is announced from some routers on the mesh, but is usually allocated in smaller `/64` networks, independent from one another, and that can be used to announce local networks.

If you wish, however, to be on the global mesh, you should use a `/48` netmask to be able to reach all nodes in the vincinity.

Known allocations:

 * `fd64:2c08:9fa7::1/48` - `roadkiller.anarcat.ath.cx` - router behind [[nodes/boulette]]
 * `fd64:2c08:9fa7:1::1/48` - `boulette.anarcat.ath.cx` - [[nodes/boulette]] itself
 * `fd64:2c08:9fa7:1::2/64` - `carton.anarcat.ath.cx` - a static node on the above network (not configured yet), announcing a subnet of the global `/48`

Notice how I have a global router (`boulette`) which has a `/48` netmask while a local access node uses a small `/64` subnet.2

### Note on ULA prefixes

ULA prefixes are "local prefixes" (think like `192.168.0.1`) but that
are unique across sites *and* can potentially be routed between
sites. See [[!rfc 4193]] for more information about this. Freifunk
[recommends we use the ULA prefixes](http://wiki.freifunk.net/6mesh.freifunk.net),
and specifically the `fdca:ffee:babe:dada::/64`, but I don't see why
we should stick with that prefix, which is bound to Freifunk
(ie. Berlin), to which we are not interconnected.

We are using `fd64:2c08:9fa7::/48` as our prefix. This prefix is advertised
from the mesh, so you should be able to see some routes and your
machine should autoconfigure itself. If you want to use a static IP in that network, document it here
first.

> *Note: the mesh prefix was chosen on
> [SixXS.net](https://www.sixxs.net/tools/grh/ula/), using the MAC
> address of my router. It was also registered there under Anarcat's
> email address.*

# Device configuration

This section documents how you can configure your device to use an IP
above. When you do, please document in the above tables and in your
[[nodes]] page, unless of course the adress is autoconfigured.

## OpenWRT

To configure the IP address on a OpenWRT device, use this:

    uci set network.lan.ipaddr=172.16.0.123
    uci set network.lan.gateway=172.16.0.1
    uci set network.lan.netmask=255.240.0.0
    uci set network.lan.dns=172.16.0.1

You may also commonly disable the DHCP server on LAN, so as to not
interfere with another router:

    uci set dhcp.lan.ignore=1

[!] Warning: the above will make it more difficult to reach the
machine again after a reboot. You will need to statically configure
your laptop if it is the only device connected to the device, for
example.

Commit changes and reboot:

    uci commit ; reboot & exit

### IPv6

IPv6 on OpenWRT requires a bit more effort.

First, install necessary packages on OpenWRT:

    opkg update
    opkg install kmod-ipv6 radvd ip kmod-ip6tables ip6tables

Then configure a static IP address:

    uci set network.lan.ip6addr="fd64:2c08:9fa7:1::2/64"

Finally the following will make sure that clients can autoconfigure:

    uci set radvd.@interface[0].ignore=0
    uci set radvd.@prefix[0].ignore=0
    uci set radvd.@prefix[0].AdvRouterAddr=1
    uci set radvd.@prefix[0].prefix=fd64:2c08:9fa7:1::2/64
    /etc/init.d/radvd enable

> *You could also replace the above by the following to make the LAN
> interface autoconfigure if there is another router present:*
    
        uci set network.lan.accept_ra=1
        uci set network.lan.send_rs=1

Make sure the IPv6 firewall is enabled:

    uci set firewall.defaults.disable_ipv6=0

Commit changes and reboot:

    uci commit ; reboot & exit

To enable routing, put this in your `/etc/sysctl.conf`:

    net.ipv6.conf.all.forwarding=1

#### Other howtos

 * [Freifunk Mesh6 documentation](http://wiki.freifunk.net/6mesh.freifunk.net)
 * [OpenWRT IPv6 howto](http://wiki.openwrt.org/doc/howto/ipv6)
 * [OpenWRT config/network reference](http://wiki.openwrt.org/doc/uci/network)
 * [SixXS.net guide to OpenWRT and IPv6](https://www.sixxs.net/wiki/Configuring_OpenWRT_on_an_NSLU2)

#### Useful tools

Force discovery

    rdisc6 bat0

Show existing nodes

    ip -6 neigh

## FreeBSD

In `rc.conf`:

    ifconfig_vr0="inet 172.16.0.42 netmask 255.240.0.0"
    defaultrouter="172.16.0.1"

If this host is to be a router, use instead:

    ifconfig_vr0="inet 172.16.0.1"
    gateway_enable="YES"

### IPv6

Here we assume that behind your mesh node, you have an "authoritative"
router which has an IPv6 netblock it wants to announce on the
mesh. This can be done with the following configurations:

In `rc.conf`:

    ipv6_ifconfig_vr2="fd64:2c08:9fa7::1/48"
    rtadvd_enable="YES"
    rtadvd_interfaces="vr2"

This can be implemented immediatly with:

    ifconfig vr2 inet6 fd64:2c08:9fa7::1/48
    rtadvd vr2

# Issues and todos

We can already observe a basic problem here: globally routable IPs are
not easily reachable from the mesh without adding static routes. This
is something I hope [[olsrd]] can fix.

Another option is to use `pinfoflags` field in `rtadvd.conf` to unset the second bit, the `autonomous address-configuration flag` (section 4.6.2 in [[!rfc 2461]]), which would disable the use of that prefix in address autoconfiguration while at the same time announcing the route. To be tested.
