[[!meta title="Internet protocols configuration"]]
[[!meta description="Includes information about IP addresses, IPv6 and routing"]]

[[!toc levels=3]]

# Device configuration

Before configuring your device, you need to choose an IP. To do this, head for the [[policy/numbering]] page and choose an IP address. Document it in the [[policy/numbering]] page and in your [[nodes]] page, unless of course the address is autoconfigured.

This section documents how you can configure your device to use the IP chosen.

## OpenWRT

To configure the IP address on a OpenWRT device, use this:

    uci set network.lan.ipaddr=172.16.0.123
    uci set network.lan.netmask=255.240.0.0
    uci set network.lan.gateway=172.16.0.1
    uci set network.lan.dns=172.16.0.1

You may also commonly disable the DHCP server on LAN, so as to not
interfere with another router:

    uci set dhcp.lan.ignore=1

[!] Warning: the above will make it more difficult to reach the
machine again after a reboot. You will need to statically configure
your laptop if it is the only device connected to the device, for
example.

Commit changes and reboot:

    uci commit ; reboot & exit

### IPv6

IPv6 on OpenWRT requires a bit more effort.

First, install necessary packages on OpenWRT:

    opkg update
    opkg install kmod-ipv6 radvd ip kmod-ip6tables ip6tables

Then configure a static IP address:

    uci set network.lan.ip6addr="fd64:2c08:9fa7:1::2/64"

Finally the following will make sure that clients can autoconfigure:

    uci set radvd.@interface[0].ignore=0
    uci set radvd.@prefix[0].ignore=0
    uci set radvd.@prefix[0].AdvRouterAddr=1
    uci set radvd.@prefix[0].prefix=fd64:2c08:9fa7:1::2/64
    /etc/init.d/radvd enable

> *You could also replace the above by the following to make the LAN
> interface autoconfigure if there is another router present:*
    
        uci set network.lan.accept_ra=1
        uci set network.lan.send_rs=1

Make sure the IPv6 firewall is enabled:

    uci set firewall.defaults.disable_ipv6=0

Commit changes and reboot:

    uci commit ; reboot & exit

To enable routing, put this in your `/etc/sysctl.conf`:

    net.ipv6.conf.all.forwarding=1

#### Other howtos

 * [Freifunk Mesh6 documentation](http://wiki.freifunk.net/6mesh.freifunk.net)
 * [OpenWRT IPv6 howto](http://wiki.openwrt.org/doc/howto/ipv6)
 * [OpenWRT config/network reference](http://wiki.openwrt.org/doc/uci/network)
 * [SixXS.net guide to OpenWRT and IPv6](https://www.sixxs.net/wiki/Configuring_OpenWRT_on_an_NSLU2)

#### Useful tools

Force discovery

    rdisc6 bat0

Show existing nodes

    ip -6 neigh

## FreeBSD

In `rc.conf`:

    ifconfig_vr0="inet 172.16.0.42 netmask 255.240.0.0"
    defaultrouter="172.16.0.1"

If this host is to be a router, use instead:

    ifconfig_vr0="inet 172.16.0.1"
    gateway_enable="YES"

### IPv6

Here we assume that behind your mesh node, you have an "authoritative"
router which has an IPv6 netblock it wants to announce on the
mesh. This can be done with the following configurations:

In `rc.conf`:

    ipv6_ifconfig_vr2="fd64:2c08:9fa7::1/64"
    rtadvd_enable="YES"
    rtadvd_interfaces="vr2"

This can be implemented immediatly with:

    ifconfig vr2 inet6 fd64:2c08:9fa7::1/64
    rtadvd vr2

# Routing issues

We can already observe a basic problem here: globally routable IPs are
not easily reachable from the mesh without adding static routes. This
is something [[babel]] can fix.

Another option is to use `pinfoflags` field in `rtadvd.conf` to unset the second bit, the `autonomous address-configuration flag` (section 4.6.2 in [[!rfc 2461]]), which would disable the use of that prefix in address autoconfiguration while at the same time announcing the route. To be tested.
