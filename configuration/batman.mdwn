[[!meta title="B.A.T.M.A.N. mesh network"]]

B.A.T.M.A.N., a "Better Approach To Mobile Ad-hoc Networking", is an alternative to [[OLSR|olsrd]]. The current implementation is "batman-adv", which works on the Layer 2. This makes the network look like "one big switch". You can use whatever layer 3 protocol on top of that (ipv4, ipv6, ipx, etc.).

[[!toc levels=3]]

# Prérequis

On assume que les étapes suivantes ont été faites avec succès:

 1. [[Flashing]] de votre routeur (avec `trunk` pour OpenWRT, voir ci-bas)
 2. Configuration du mode [[ad-hoc]]

# Installer et configurer BATMAN

## OpenWRT

*Ceci est un résumé de l'excellent [[Guide d'installation de BATMAN sur OpenWRT|guides/openwrt+batman]].*

[!] **Important**: il faut utiliser une *version récente* de OpenWRT  (`trunk` au moment d'écrire ces lignes) pour obtenir de bons résultats (BATMAN 2012). Voir [[flashing]] pour plus d'informations sur l'architecture à utiliser. `backfire` n'est *pas* compatible.

Pour installer batman-adv:

    opkg update
    opkg install kmod-batman-adv

> (!) Si l'installation cause problème (prend trop de temps, donne erreur de mémoire insuffisante), alors il faut télécharger "à la main" le paquet et sa dépendance (kmod-lib-crc16 dans trunk et kmod-crc16 dans backfire). Il faut trouver l'URL du paquet et faire quelque chose comme ceci pour un Linksys WRT54g:

        cd /tmp
        touch /tmp/opkg.conf
        opkg -f /tmp/opkg.conf install http://downloads.openwrt.org/snapshots/trunk/brcm47xx/packages/kmod-lib-crc16_3.2.13-1_brcm47xx.ipk \
            http://downloads.openwrt.org/snapshots/trunk/brcm47xx/packages/kmod-batman-adv_3.2.13+2012.0.0-1_brcm47xx.ipk

> Voir [[flashing]] pour plus d'informations sur l'architecture à utiliser.

Changement du MTU de l'interface wifi:

    uci set network.wlan0.mtu=1528

> [!] Il n'est pas clair que ceci est réellement nécessaire.

Configuration de l'interface de batman.

    uci set network.bat0=interface
    uci set network.bat0.ifname=bat0
    uci set network.bat0.proto=none
    uci set network.bat0.mtu=1500

The 'lan' bridge can be configured to add bat0 as well as eth0:

    uci set network.lan.ifname="eth0 bat0"

(!) The above may be eth0.0 instead of eth0. For linksys it's eth0.0,
for ubiquity it's eth0. Look at the output of ifconfig to see what's
the eth0 interface.

Tell batman to use the wireless interface *and* the local bridge:

    uci set batman-adv.bat0.interfaces="wlan0 br-lan"

Reboot the router

    uci commit
    reboot & exit

## Debian

Sous Debian/Ubuntu, installer le package Debian pour batctl, qui permet de gérer le module kernel inclus dans Linux:

    sudo apt-get install -t squeeze-backports batctl linux-image

[!] Ceci demande un [backport](http://backports-master.debian.org/Instructions/) uploadé récemment, voir [[!debbug 668237]] pour les détails.

Pour nos tests, ça fonctionnait très bien avec linux 3.2, avec batctl version 2012.0.0. On a également noté que la version du module de noyau batman-adv est 2011.4.0 pour linux 3.2. Il semble y avoir une couche de compatibilité dans les versions futures ?? à voir...

Si vous avez mis à jour votre noyau, il faut redémarrer la machine.

Activer le module kernel (la majorité des distributions Linux ont ce module par défaut)

    modprobe batman-adv

Suivre ensuite la configuration manuelle ci-bas.

## Arch linux

On besoin de l'[[AUR | https://aur.archlinux.org/]]

    # modprobe batman_adv
    $ yaourt -S batctl

Suivre ensuite la configuration manuelle ci-bas.

# Configuration manuelle

Toutes les plateformes peuvent être configurées manuellement avec ces
instructions, qui devront être configurés dans un script de démarrage
éventuellement.

Ajouter une interface physique à batman:

    ifconfig wlan0 mtu 1528 up
    batctl if add wlan0

> (!) Notez comment le MTU est augmenté à cause des messages de
> protocole de BATMAN.

Activer l'interface:

    ifconfig bat0 up

L'interface doit ensuite être configurée

# Étape suivante

Voir [[la configuration IP|configuration/ip]].

## Use our bat-hosts

You may have noticed that `batctl tcpdump` and other commands display MAC addresses, and tried to match these adresses to your network interfaces. Do no more! You can use our [[bat-hosts|configuration/bat-hosts]] file to let batman display nice, user-friendly names (such as 'boulette', our very first Ubiquiti "Bullet").

# Troubleshooting

## Informations générales

En général, batman ou le mode ad-hoc affiche régulièrement des messages kernel, on peut y accéder par:

    dmesg | tail

ou:

    tail -f /var/log/messages

## Afficher l'état

    batctl if

## Diagnostiques

Même si on a pas d'adresse IP configurée, on peut faire des "pings" en utilisant les adresses MAC:

    batctl tcpdump wlan0
    batctl ping 00:11:22:33:44:55
    batctl traceroute 00:11:22:33:44:55

Autres commandes utiles pour voir les nodes locales (mesh seulement) ou toutes les nodes accessibles via le mesh (global):

    batctl translocal
    batctl transglobal

# Bugs

## BATMAN network unreachable from others

With the current configuration, I cannot ping the third hop in a three-hop relay. In my test setup, my laptop (angela, `192.168.3.44`) is connected through the mesh to a Linksys AP (carton, `192.168.3.99`), which is strong enough to reach the Bullet on my roof (boulette, `192.168.3.90`).

carton can ping boulette, and angela can ping carton, but not boulette. I get `Destination port unreachable`, I assume because of that nasty firewall, because I see ARP requests go through fine. --[[anarcat]]

> This works now, the problem was I was trying to live outside the main bridge: don't try, you will fail. --[[anarcat]]

# Références

 * [Main project page open-mesh.org](http://www.open-mesh.org/)
  * [batman-adv](http://www.open-mesh.org/projects/batman-adv/wiki)
  * [batman-adv quickstart guide](http://www.open-mesh.org/wiki/batman-adv/Quick-start-guide)
  * [user guide with most of the docs](http://www.open-mesh.org/wiki/open-mesh/UserDocs)
