[[!meta title="B.A.T.M.A.N. mesh network"]]

B.A.T.M.A.N., a "Better Approach To Mobile Ad-hoc Networking", is an alternative to [[OLSR|olsrd]]. The current implementation is "batman-adv", which works on the Layer 2. This makes the network look like "one big switch". You can use whatever layer 3 protocol on top of that (ipv4, ipv6, ipx, etc.).

[[!toc levels=3]]

# OpenWRT

See [[Batman on OpenWRT|configuration/batman/openwrt]]

# Prérequis

 1. [[Flashing]] de votre routeur
 2. Configuration du mode [[ad-hoc]]

## Installer les logiciels nécessaires

ATTENTION: toutes les nodes doivent utiliser la même version de batman-adv. Par conséquent, il faut la dernière version du module (2012.0) pour votre noyau Linux.

### Sur Debian

Sous Debian/Ubuntu, installer le package Debian pour batctl (gestion des configurations)

    sudo apt-get install batctl

Idéalement il faut aussi un noyau Linux qui est à jour. Pour nos tests, ça fonctionnait très bien avec linux 3.2, avec batctl version 2012.0.0.
Par exemple:

    uname -a
    apt-cache search linux-image-3
    sudo apt-get install linux-image-3.2.0-1-686-pae

Si vous avez mis à jour votre noyau, il faut redémarrer la machine.

Activer le module kernel (la majorité des distributions Linux ont ce module par défaut)

    modprobe batman-adv

Configurer l'interface physique wifi pour le mode adhoc du mesh. Il faut probablement désactiver network-manager.

    sudo /etc/init.d/network-manager stop
    iwconfig wlan0  mode ad-hoc  channel 1  essid mesh-mtl  ap 02:51:48:72:03:11

Configurer l'interface réseau, il faut augmenter le MTU car les "packets" de Batman ajoutent des données aux frames ethernet:

    ifconfig wlan0 mtu 1528 192.168.8.2 up

Ajouter l'interface à Batman:

    batctl if add wlan0

### Sur Archlinux
On besoin de l'[[AUR | https://aur.archlinux.org/]]

    # modprobe batman_adv
    $ yaourt -S batctl

### Sur OpenWRT

See [[configuration/batman/openwrt]]


### Sur DD-WRT

TODO: [[configuration/batman/dd-wrt]]

### Sur AirOS (Ubiquiti)

TODO: [[configuration/batman/air-os]]

# Configuration de Batman

Afficher l'état:

    batctl if

Activer l'interface:

    ifconfig bat0 up

Voilà, on n'a pas d'adresses IP de configurées (à moins d'utiliser IPv6, todo: à documenter), mais on peut faire des "pings" en utilisant les adresses MAC:

    batctl tcpdump wlan0
    batctl ping 00:11:22:33:44:55
    batctl traceroute 00:11:22:33:44:55

Autres commandes utiles pour voir les nodes locales (mesh seulement) ou toutes les nodes accessibles via le mesh (global):

    batctl translocal
    batctl transglobal

## Assignation d'adresses IP

Si on veut faire une communication utile entre les machines, il faut assigner des adresses IP. On peut utiliser du DHCP, des adresses statiques ou IPv6.

## IPv4 statique

Assigner une adresse unique par machine. Par exemple:

    ifconfig bat0 192.168.1.10

## IPv6 avec les adresses locales

todo

## IPv6 avec routage et découverte "stateless"

todo

# Diagnostiques

En général, batman ou le mode ad-hoc affiche régulièrement des messages kernel, on peut y accéder par:

    dmesg | tail

ou:

    tail -f /var/log/messages

Voir aussi la page [[ad-hoc]] si vous avez des difficultés avec le
lien physique.

# Références

 * [Main project page open-mesh.org](http://www.open-mesh.org/)
  * [batman-adv](http://www.open-mesh.org/projects/batman-adv/wiki)
  * [batman-adv quickstart guide](http://www.open-mesh.org/wiki/batman-adv/Quick-start-guide)
  * [user guide with most of the docs](http://www.open-mesh.org/wiki/open-mesh/UserDocs)
