[[!meta title="B.A.T.M.A.N. mesh network"]]

B.A.T.M.A.N., a "Better Approach To Mobile Ad-hoc Networking", is an alternative to [[OLSR|olsrd]]. The current implementation is "batman-adv", which works on the Layer 2. This makes the network look like "one big switch". You can use whatever layer 3 protocol on top of that (ipv4, ipv6, ipx, etc.).

[[!toc levels=3]]

# Installation sur Debian

## Installer les logiciels nécessaires

Sous Debian/Ubuntu, installer le package Debian pour batctl (gestion des configurations)

    sudo apt-get install batctl

Idéalement il faut aussi un noyau Linux qui est à jour. Pour nos tests, ça fonctionnait très bien avec linux 3.2, avec batctl version 2011.0.0 ou 2012.0.0.
Par exemple:

    uname -a
    apt-cache search linux-image-3
    sudo apt-get install linux-image-2.3.0-1-686-pae

Si vous avez mis à jour votre noyau, il faut redémarrer la machine.

Activer le module kernel (la majorité des distributions Linux ont ce module par défaut)

    modprobe batman-adv

### Configuration du mode ad hoc

Découvrir quelle est l'interface réseau (ex: wlan0) :

    /sbin/iwconfig

À partir d'ici, on assume que vous êtes "root" (sudo -s).

Configurer le mode ad-hoc:

    iwconfig wlan0 mode ad-hoc essid mesh-mtl

Quand le mode ad-hoc est bien configuré, on peut voir dans "iwconfig" que la carte est "associée" et on voit aussi avec quelle cellule (une MAC). La cellule devrait être la même sur toutes les machines. Sinon, descendre l'interface réseau (voir même désactiver son module noyau) et la ré-activer.

## Configuration de Batman

Configurer l'interface réseau, il faut augmenter le MTU car les "packets" de Batman ajoutent des données aux frames ethernet:

    ifconfig wlan0 mtu 1528 up

Ajouter l'interface à Batman:

    batctl if add wlan0

Afficher l'état:

    batctl if

Activer l'interface:

    ifconfig bat0 up

Voilà, on n'a pas d'adresses IP de configurées (à moins d'utiliser IPv6, todo: à documenter), mais on peut faire des "pings" en utilisant les adresses MAC:

    batctl tcpdump wlan0
    batctl ping 00:11:22:33:44:55
    batctl traceroute 00:11:22:33:44:55

Autres commandes utiles pour voir les nodes locales (mesh seulement) ou toutes les nodes accessibles via le mesh (global):

    batctl translocal
    batctl transglobal

## Assignation d'adresses IP

Si on veut faire une communication utile entre les machines, il faut assigner des adresses IP. On peut utiliser du DHCP, des adresses statiques ou IPv6.

## IPv4 statique

Assigner une adresse unique par machine. Par exemple:

    ifconfig bat0 192.168.1.10

## IPv6 avec les adresses locales

todo

## IPv6 avec routage et découverte "stateless"

todo

## Diagnostiques

En général, batman ou le mode ad-hoc affiche régulièrement des messages kernel, on peut y accéder par:

    dmesg | tail
    tail -f /var/log/messages

Si Network Manager est actif, vous pourriez voir:

    iwconfig wlan0 mode ad-hoc essid mesh-mtl
    Error for wireless request "Set Mode" (8B06) :
        SET failed on device wlan0 ; Device or resource busy.

Il faut alors désactiver le réseau, avec l'icône dans Gnome.

## Problèmes à créer une connexion ad-hoc

Désactiver puis ré-activer la carte réseau (malheureusement, il faut deviner le module de la carte, pas toujours évident). Au pire, redémarrer.

    lsmod
    lsmod | grep 802
    rmmod iwlwifi
    modprobe iwlwifi

Ça peut être utile d'assigner une adresse statique sur l'interface ad-hoc pour confirmer que la connexion fonctionner bien. Assigner une adresse unique par machine, par exemple:

    machine A: ifconfig wlan0 192.168.1.10
    machine B: ifconfig wlan0 192.168.1.11
    machine C: ifconfig wlan0 192.168.1.12

Puis utiliser la commande "ping" pour voir si on peut parler à une autre machine.

# Installation sur OpenWRT

[DRAFT]

Pas d'images pré-compilées? Peut-on installer en module dans OpenWRT standard? Le package n'est pas dispo:

    ipkg update
    ipkg install batman-adv

## Compiler OpenWRT avec batman

Instructions génériques pour compiler OpwnWRT: http://wiki.openwrt.org/doc/howto/build

http://www.open-mesh.org/wiki/batman-adv/Building-with-openwrt

Il faut choisir un noyau 2.6 (PAS 2.4) dans 'make menuconfig'.

Flasher le fichier '.trx' compilé dans le répertoire bin de OpenWRT.

Connecter câble ethernet.

    telnet 192.168.1.1
    passwd

Reboot

Tester 'batctl', et vérifier que l'interface wifi existe: 'iw'.

    iw phy phy0 interface add wlan0 type adhoc
    iwconfig wlan0 mode adhoc essid mesh-mtl
    ifconfig wlan0 mtu 1528 up
    batctl if add wlan0
    ifconfig bat0 up
    batctl tcpdump wlan0

# Installation sur DD-WRT

todo

# Installation sur AirOS (Ubiquiti)

todo

# Références

 * [Main project page open-mesh.org](http://www.open-mesh.org/)
  * [batman-adv](http://www.open-mesh.org/projects/batman-adv/wiki)
  * [batman-adv quickstart guide](http://www.open-mesh.org/wiki/batman-adv/Quick-start-guide)
  * [user guide with most of the docs](http://www.open-mesh.org/wiki/open-mesh/UserDocs)
