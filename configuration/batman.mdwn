[[!meta title="B.A.T.M.A.N. mesh network"]]

B.A.T.M.A.N., a "Better Approach To Mobile Ad-hoc Networking", is an alternative to [[OLSR|olsrd]]. The current implementation is "batman-adv", which works on the Layer 2. This makes the network look like "one big switch". You can use whatever layer 3 protocol on top of that (ipv4, ipv6, ipx, etc.).

[[!toc levels=3]]

# Prérequis

 1. Configuration du mode [[ad-hoc]]
 2. [[Flashing]] de votre routeur

## Installer les logiciels nécessaires

ATTENTION: toutes les nodes doivent utiliser la même version de batman-adv. Par conséquent, il faut la dernière version du module (2012.0) pour votre noyau Linux.

### Sur Debian

Sous Debian/Ubuntu, installer le package Debian pour batctl (gestion des configurations)

    sudo apt-get install batctl

Idéalement il faut aussi un noyau Linux qui est à jour. Pour nos tests, ça fonctionnait très bien avec linux 3.2, avec batctl version 2012.0.0.
Par exemple:

    uname -a
    apt-cache search linux-image-3
    sudo apt-get install linux-image-2.3.0-1-686-pae

Si vous avez mis à jour votre noyau, il faut redémarrer la machine.

Activer le module kernel (la majorité des distributions Linux ont ce module par défaut)

    modprobe batman-adv

### Sur OpenWRT

Pas d'images pré-compilées? Peut-on installer en module dans OpenWRT standard? Le package n'est pas dispo:

    ipkg update
    ipkg install batman-adv

Instructions génériques pour compiler OpwnWRT: http://wiki.openwrt.org/doc/howto/build

http://www.open-mesh.org/wiki/batman-adv/Building-with-openwrt

Il faut choisir un noyau 2.6 (PAS 2.4) dans 'make menuconfig'.

[[Flasher|flashing]] le fichier '.trx' compilé dans le répertoire bin de OpenWRT.

Connecter câble ethernet.

    telnet 192.168.1.1
    passwd

Reboot

Configurer le réseau [[ad-hoc]]:

    iw phy phy0 interface add wlan0 type adhoc
    iwconfig wlan0 mode adhoc essid mesh-mtl

... faire le reste de la configuration plus bas.

TODO: Utiliser UCI (Unified Configuration Interface) pour que la configuration se conserve après un reboot. http://wiki.openwrt.org/doc/uci Exemple avec Batman: http://pizza.hskflashcards.com/index.php?page=B.A.T.M.A.N.+Advanced+on+OpenWrt+How-To

### Sur DD-WRT

todo

### Sur AirOS (Ubiquiti)

todo

# Configuration de Batman

Configurer l'interface réseau, il faut augmenter le MTU car les "packets" de Batman ajoutent des données aux frames ethernet:

    ifconfig wlan0 mtu 1528 up

Ajouter l'interface à Batman:

    batctl if add wlan0

Afficher l'état:

    batctl if

Activer l'interface:

    ifconfig bat0 up

Voilà, on n'a pas d'adresses IP de configurées (à moins d'utiliser IPv6, todo: à documenter), mais on peut faire des "pings" en utilisant les adresses MAC:

    batctl tcpdump wlan0
    batctl ping 00:11:22:33:44:55
    batctl traceroute 00:11:22:33:44:55

Autres commandes utiles pour voir les nodes locales (mesh seulement) ou toutes les nodes accessibles via le mesh (global):

    batctl translocal
    batctl transglobal

## Assignation d'adresses IP

Si on veut faire une communication utile entre les machines, il faut assigner des adresses IP. On peut utiliser du DHCP, des adresses statiques ou IPv6.

## IPv4 statique

Assigner une adresse unique par machine. Par exemple:

    ifconfig bat0 192.168.1.10

## IPv6 avec les adresses locales

todo

## IPv6 avec routage et découverte "stateless"

todo

# Diagnostiques

En général, batman ou le mode ad-hoc affiche régulièrement des messages kernel, on peut y accéder par:

    dmesg | tail

ou:

    tail -f /var/log/messages

Voir aussi la page [[ad-hoc]] si vous avez des difficultés avec le
lien physique.

# Références

 * [Main project page open-mesh.org](http://www.open-mesh.org/)
  * [batman-adv](http://www.open-mesh.org/projects/batman-adv/wiki)
  * [batman-adv quickstart guide](http://www.open-mesh.org/wiki/batman-adv/Quick-start-guide)
  * [user guide with most of the docs](http://www.open-mesh.org/wiki/open-mesh/UserDocs)
