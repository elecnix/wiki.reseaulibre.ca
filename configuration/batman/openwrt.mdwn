[[!meta title="Batman on OpenWRT"]]

[[!toc levels=2]]

This page is about installing B.A.T.M.A.N. on OpenWRT. For other target installations, see the [[Batman Configuration|configuration/batman]] page.

# Install OpenWRT

To install OpenWRT, you must [[flash your router|configuration/flashing]] with a recent version. **The recommended version is _trunk_**. Il existe des [[images trunk pré-compilées|http://downloads.openwrt.org/snapshots/trunk/]] pour chaque matériel supporté.

Il y a un paquet nommé kmod-batman-adv pour OpenWRT. Dans la version stable de OpenWRT ('backfire'), on retrouve une ancienne version de batman: 2011.2.0. Les noeuds de Montréal sont installés avec la version 2012.0.0 de batman. Il faut donc installer la version 'trunk' de OpenWRT.

Il est aussi possible de [[compiler soi-même OpenWRT|http://wiki.openwrt.org/doc/howto/build]] et [[compiler batman en même temps|http://www.open-mesh.org/wiki/batman-adv/Building-with-openwrt]].

# Basic Network Configuration

Connect a cable from the LAN to your PC.
Set your PC to get an IP address automatically.
Get into the router with its default IP address.

    telnet 192.168.1.1

This command can be used to backup or inspect your current
configuration:

    uci show

Configure the router LAN interface to match the network
of the home router this will be plugged into eventually.

    uci set network.lan.ipaddr=192.168.3.88
    uci set network.lan.gateway=192.168.3.1
    uci set network.lan.dns=192.168.3.1

Disable DHCP server on LAN, so as to not interfere with home router.

    uci set dhcp.lan.ignore=1

Activer la radio

    uci delete wireless.radio0.disabled

Set a custom name, in case you encouter other peers :-)

    uci set system.@system[0].hostname=batman-88

Écrire les changements et redémarrer

    uci commit
    reboot & exit

> Note: only restarting network will not update the DHCP server.

# Batman Installation

Disconnect the PC from the router and now connect both the
PC and the mesh router to the home router.
Re-connect to the router using its new IP address.

    telnet 192.168.3.88

Install B.A.T.M.A.N (the home router provides access to internet)

    opkg update
    opkg install kmod-batman-adv

> Si l'installation cause problème (prend trop de temps, donne erreur de mémoire insuffisante), alors il faut télécharger "à la main" le paquet et sa dépendance (kmod-lib-crc16 dans trunk et kmod-crc16 dans backfire). Il faut trouver l'URL du paquet et faire quelque chose comme ceci pour un Linksys WRT54g:

    cd /tmp
    touch /tmp/opkg.conf
    opkg -f /tmp/opkg.conf install http://downloads.openwrt.org/snapshots/trunk/brcm47xx/packages/kmod-lib-crc16_3.2.13-1_brcm47xx.ipk \
        http://downloads.openwrt.org/snapshots/trunk/brcm47xx/packages/kmod-batman-adv_3.2.13+2012.0.0-1_brcm47xx.ipk

Pour un Ubiquiti Bullet, il faut plutôt utiliser les paquets pour ar71xx:

    opkg -f /tmp/opkg.conf install http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/kmod-batman-adv_3.2.9+2012.0.0-1_ar71xx.ipk \
        http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/kmod-lib-crc16_3.2.9-1_ar71xx.ipk

Le module `batman_adv` devrait maintenant être chargé:

    lsmod | grep batman

You should see: batctl 2012.0.0

    batctl -v

# Wireless Configuration

We have enabled wireless previously. Now, verify that the wifi interface
is listed. If not, you must have flashed the wrong image!

    iwconfig

Wifi network no longer 'lan'

    uci delete wireless.@wifi-iface[0].network

Montreal mesh standards: channel 1, adhoc, named mesh-mtl. Il faut specifier un BSSID pour s'assurer que tous les routeurs soient dans la meme cellule.

    uci set wireless.radio0.channel=1
    uci set wireless.@wifi-iface[0].mode=adhoc
    uci set wireless.@wifi-iface[0].ssid=mesh-mtl
    uci set wireless.@wifi-iface[0].bssid=02:51:48:72:03:11

Configuration de l'interface sans-fil avec MTU plus élevé pour batman:

    uci set network.wlan0=interface
    uci set network.wlan0.ifname=wlan0
    uci set network.wlan0.proto=none
    uci set network.wlan0.mtu=1528

# Batman Configuration

Configuration de l'interface de batman. We're not assigning an IP address to `bat0` because we'll add it to the `lan` bridge.

    uci set network.bat0=interface
    uci set network.bat0.ifname=bat0
    uci set network.bat0.proto=none
    uci set network.bat0.mtu=1500

The 'lan' bridge should include bat0 as well as eth0:

    uci set network.lan.ifname="eth0 bat0"

(!) The above may be eth0.0 instead of eth0. For linksys it's eth0.0,
for ubiquity it's eth0. Look at the output of ifconfig to see what's
the eth0 interface.

Tell batman to use the wireless and the lan interfaces.

    uci set batman-adv.bat0.interfaces="wlan0 br-lan"

You're done! Commit the changes and reboot to test them.

    uci commit
    reboot & exit

# Testing

After a reboot, you should see `wlan0: active` and `br-lan: active` with this:

[[!format txt """
root@batman-88:/# brctl show
bridge name     bridge id               STP enabled     interfaces
br-lan          8000.00259c5e4457       no              eth0.0
                                                        bat0
root@batman-88:/# batctl if
wlan0: active
br-lan: active
"""]]
