[[!toc levels=3]]
[[!meta title="Ad-hoc network configuration"]]

# Debian configuration

Découvrir quelle est l'interface réseau (ex: wlan0) :

    /sbin/iwconfig

À partir d'ici, on assume que vous êtes "root" (sudo -s).

This will bring up your network interface with an IP in the 10.0.0.0/8 range.

    iwconfig wlan0 mode ad-hoc essid mesh-mtl ap 02:51:48:72:03:11
    ifconfig wlan0 10.0.1.42 netmask 255.0.0.0 up

Quand le mode ad-hoc est bien configuré, on peut voir dans "iwconfig" que la carte est "associée" et on voit aussi avec quelle cellule (une MAC). La cellule devrait être la même sur toutes les machines. Sinon, descendre l'interface réseau (voir même désactiver son module noyau) et la ré-activer.

## Problèmes communs

### Interface non-supportée par iwconfig

<http://linuxwireless.org/en/developers/Documentation/nl80211> -
it seems the proper way to configure interfaces is not through
iwconfig anymore. see [[!debbug 645055]] too. The following could work
for your hardware:

    iw dev wlan0 interface add wlan1 type adhoc

### Device or resource busy

Si Network Manager est actif, vous pourriez voir:

    iwconfig wlan0 mode ad-hoc essid mesh-mtl
    Error for wireless request "Set Mode" (8B06) :
        SET failed on device wlan0 ; Device or resource busy.

Il faut alors désactiver le réseau, avec l'icône dans Gnome.

### Problèmes à créer une connexion ad-hoc

Désactiver puis ré-activer la carte réseau (malheureusement, il faut deviner le module de la carte, pas toujours évident). Au pire, redémarrer.

    lsmod
    lsmod | grep 802
    rmmod iwlwifi
    modprobe iwlwifi

Il peut arriver que cette methode ne fonctionne pas. Avec une carte Intel Centrino sur un Thinkpad Lenovo, la commande

    dmesg | tail

Montre qu'il y a un probleme dans l'obtention, ou l'identification du firmware de la carte:

    iwlwifi 0000:03:00.0: request for firmware file 'iwlwifi-6000-4.ucode' failed.

Pourtant, ce fichier est disponible dans /lib/firmware, si la carte etait fonctionnelle auparavant. C'est un probleme qui semble etre documente de toute part sur le net. Dans ce cas, la solution simple est malheureusement de redemarrer la machine.

Ça peut être utile d'assigner une adresse statique sur l'interface ad-hoc pour confirmer que la connexion fonctionner bien. Assigner une adresse unique par machine, par exemple:

    machine A: ifconfig wlan0 192.168.1.10
    machine B: ifconfig wlan0 192.168.1.11
    machine C: ifconfig wlan0 192.168.1.12

Puis utiliser la commande "ping" pour voir si on peut parler à une autre machine.

### Key encryption

Dans le cas d'un laptop qui n'est pas dedie au mesh, il se peut que la configuration de l'interface wlan0 traine des flags de ses configurations precedentes. 

    iwconfig wlan0

devrait montrer

    wlan0     IEEE 802.11abgn  ESSID:"mesh-mtl"  
              Mode:Ad-Hoc  Frequency:2.412 GHz  Cell: 02:51:48:72:03:11   
              Tx-Power=15 dBm   
              Retry  long limit:7   RTS thr:off   Fragment thr:off
              Encryption key:off
              Power Management:off

Pourtant, il est possible que d'une autre machine, par exemple un routeur OpenWRT, la commande

    iwlist wlan0 scan

montre que notre cellule a son "Encryption key" a "on"

    Cell 10 - Address: 02:51:48:72:03:11
                Channel:1
                Frequency:2.412 GHz (Channel 1)
                Quality=70/70  Signal level=-25 dBm  
                Encryption key:on
                ESSID:"mesh-mtl"
                Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 6 Mb/s
                          9 Mb/s; 12 Mb/s; 18 Mb/s
                Bit Rates:24 Mb/s; 36 Mb/s; 48 Mb/s; 54 Mb/s
                Mode:Ad-Hoc
                    
On peut changer ceci sur la machine Debian, avec la commande

    iwconfig wlan0 key off


# OpenWRT configuration

## Through the luci web interface

 1. enable the device by checking (./) the enable checkbox in the `Devices`
 2. choose an appropriate channel
 3. fill in the details

        Network Name (ESSID): mesh-mtl
        BSSID: <copy existing bssid>
        Mode: Independent (Ad-Hoc)
        Encryption: No Encryption
        Network: wlan <new>

Note the latter part is important: this segregates the wifi from the lan
bridge, which allows to stay have diffent networks for the diagnostic
wire and the wireless.

Then head for the `Network -> Interfaces` configuration page, enable the
wlan network and assign the following settings:

    Protocol: static
    IPv4-Address: 10.0.1.1
    IPv4-Netmask: 255.0.0.0
    Zone: lan
    Interface: wlan0

Leave the rest as is.

## Configuration file

The above yields the following configuration, in `/etc/config/wireless`:

    config 'wifi-device' 'radio0'
            option 'type' 'mac80211'
            option 'channel' '5'
            option 'macaddr' '00:90:4c:5f:00:2a'
            option 'hwmode' '11g'
            option 'disabled' '0'
    
    config 'wifi-iface'
            option 'device' 'radio0'
            option 'network' 'wlan0'
            option 'encryption' 'none'
            option 'ssid' 'mesh-mtl'
            option 'mode' 'adhoc'
            option 'bssid' '02:51:48:72:03:11'

And this chunk ends up in `/etc/config/network`:

    config 'interface' 'wlan0'
            option 'proto' 'static'
            option 'ifname' 'wlan0'
            option 'ipaddr' '10.0.1.1'
            option 'netmask' '255.0.0.0'
            option 'defaultroute' '0'
            option 'peerdns' '0'

also note that in the `/etc/config/firewall` file, you'll see that the
wlan0 interface is assigned to the lan zone:

    config 'zone'
            option 'name' 'lan'
            option 'input' 'ACCEPT'
            option 'output' 'ACCEPT'
            option 'forward' 'REJECT'
            option 'network' 'lan wlan0'

[[!meta copyright="Copyright © 2011 Antoine Beaupré"]]

[[!meta license="""[[!toggle id="license" text="GFDL 1.2+"]][[!toggleable
id="license" text="Permission is granted to copy, distribute and/or modify this
document under the terms of the GNU Free Documentation License, Version 1.2 or
any later version published by the Free Software Foundation; with no Invariant
Sections, no Front-Cover Texts, and no Back-Cover Texts.  A copy of the license
is included in the section entitled [[GNU Free Documentation
License|meta/gfdl]]."]]"""]]
