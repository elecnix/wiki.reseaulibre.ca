This wiki is designed to be distributed and "redundant" (as in having
multiple copies). Basically, this is to allow you to access the
documentation even if the network goes down. This is done through
[[ikiwiki]], which is a the engine behind this wiki.

(!) Note that this is all much easier with the "branchable" plugin of
the [[ikiwiki-hosting|http://ikiwiki-hosting.branchable.com/]] package.

[[!toc]]

# Basic offline editing and sharing

Basically, this wiki is a collection of [[ikiwiki/markdown]]-formatted pages
committed to a git repository. The git repository can be freely cloned
using this command:

    git clone git://wiki.reseaulibre.ca/

This will at least provide you with the raw source, the text files
that generate the wiki website. There you can make changes and send me
the patches by email.

# Creating a mirror

To create a mirror of this wiki, if it ever goes down, you can start
from the above repository and create a new wiki.

## Preparation

You need to install the `ikiwiki` package for the mirror to work. You
can use ikiwiki to publish the actual HTML pages elsewhere if you
don't plan on letting people edit the wiki, but generally you want the
package to be installed on the webserver for editing to work.

    apt-get install ikiwiki

Make sure you run at least version `3.20120319` of ikiwiki, available
in since Debian squeeze (through backports). However, there were
several bugfixes to the OpenStreetMap plugin (`osm`) in `3.20120725`,
which is available only since Debian Jessie. To enable Debian Jessie
repositories on your Debian install, use:

    cat > /etc/apt/preferences.d/jessie.pref <<EOF
    Package: *
    Pin: release a=jessie
    Pin-Priority: 1
    EOF
    echo 'deb http://ftp.ca.debian.org/debian/ jessie main' > /etc/apt/sources.list.d/jessie.list
    apt-get install -t jessie ikiwiki

If you disable the osm plugin and do not use the map feature, you
don't need to worry about versions.

## Setting up the wiki

The following steps should get you going:

    cd /var/www
    git clone git://wiki.reseaulibre.ca/ wiki.reseaulibre.ca
    cd wiki.reseaulibre.ca
    git branch setup origin/setup
    cd ../
    git clone -b setup wiki.reseaulibre.ca setup
    cd setup
    edit ikiwiki.setup # fix paths
    ikiwiki --setup ikiwiki.setup

When editing `ikiwiki.setup`, make sure you change the following entries:

    cgiurl: http://wiki.reseaulibre.ca/ikiwiki.cgi
    cgi_wrapper: /var/www/ikiwiki.cgi
    srcdir: /home/anarcat/wikis/wiki.reseaulibre.ca
    destdir: /var/www/wiki.reseaulibre.ca
    libdir: /home/anarcat/wikis/wiki.reseaulibre.ca/.ikiwiki
    git_wrapper: /home/anarcat/wikis/wiki.reseaulibre.ca/.git/hooks/post-commit
    git_test_receive_wrapper: /home/anarcat/wikis/wiki.reseaulibre.ca/.git/hooks/pre-receive
    gitorigin_branch: "" # disable
    ENV:
      TMPDIR: /home/anarcat/tmp

This assumes that your `/var/www/wiki.reseaulibre.ca` directory is
available in a virtual host named `wiki.reseaulibre.ca`. This needs
special configuration in your webserver.

## Apache configuration

    <VirtualHost *:80>
        ServerName wiki.reseaulibre.ca:80
        DocumentRoot /var/www/wiki.reseaulibre.ca
        <Directory /var/www/wiki.reseaulibre.ca>
            Options Indexes MultiViews ExecCGI
            AllowOverride None
            Order allow,deny
            allow from all
        </Directory>
        ScriptAlias /ikiwiki.cgi /var/www/ikiwiki.cgi
        ErrorDocument 404 "/ikiwiki.cgi"
    </VirtualHost>

## Nginx configuration

    server {
        root /var/www/wiki.reseaulibre.ca/;
        index index.html index.htm;

        # Make site accessible from http://localhost/
        server_name wiki.reseaulibre.ca;

        location / {
            try_files $uri $uri/ /index.html;
        }
        location /ikiwiki.cgi {
            fastcgi_pass  unix:/tmp/fcgi.socket;
            fastcgi_index ikiwiki.cgi;
            fastcgi_param SCRIPT_FILENAME   /var/www/ikiwiki.cgi;
            fastcgi_param  DOCUMENT_ROOT      /var/www/wiki.reseaulibre.ca;
            include /etc/nginx/fastcgi_params;
        }
    }

Start this process as your own user (or the user that has write access
to `srcdir`, `destdir`, etc):

    spawn-fcgi -s /tmp/fcgi.socket -n -- /usr/sbin/fcgiwrap

Make this writable:

    chmod a+w /tmp/fcgi.socket

## Other configuration

Disable the `search`, `ikiwikihosting` and `branchable` plugins.

Another guide is the [[!iki tips/laptop_wiki_with_git]] guide. To get a
better understanding of how ikiwiki works, see [[!iki rcs/git]].

Once the wiki can generate pages, you may need to go over the
[[meta/Maintenance]] guide for the plugins to enable and the hooks
configuration.

You will also need a webserver to serve the content in the `destdir`
defined above. This configuration varies wildly, but the ikiwiki
documentation ([[!iki setup]] and [[!iki tips/dot_cgi]]) has some
hints.

(!) Oh, and [this](http://piny.be/jrayhawk/notes/ikiwiki_creation/)
may also be of use if the above doesn't work.

There is some work being done to host copies of this wiki on OpenWrt nodes. See [[meta/ikiwiki+openwrt]].

# Keeping the mirror up to date

There are two options here. One is to regularly pull from the master (less reliable, klunky, but doesn't require cooperation from the master), the other is to make the master push to the mirror. For this, the master needs to enable the [[!iki plugins/gitpush]] plugin and add the following to the setup file:

    git_push_to:
    - ssh://user@example.com/source.git

The repository URL above needs to point to the "repository" directory of the mirror, see the [[!iki rcs/git]] documentation for a good explanation of the layout of the different git repositories in ikiwiki.

It also needs to allow the following SSH key to push to the repository:

    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDQsHWlypnPe+4e0mKkE51oDHK2yXrEeja6299Es/wFvqihvzY4hQhJdUdl2KVmz5CGjRYqhnQ8l5Al5vtHoi9IxlI7yS7cOsj/wFt4EKDophqoyUFDaiWtXuFCNYwdTeX5Fb9N6nT8ihUUK/q9k8Ew9kuBTbznsVra5zqJv+LhfAMIesPwmP6iF966Evi0uXxz0CkIevttvYgRZyPIvdVN90nr5f7um1vOP6L1KkQne8guHpuNfxd9XZg0e3XPG6decGREy8jdOc3xlIADc+yxKpB+XqZyE3iYi2RsxnjqWbSURvOhvI5z4EVj5Qv8ktSj8g3LkukQr25EgNMl1cv9 r-wiki@marcos

# Publishing the mirror

Once your mirror works, it needs to be added to the list of mirrors. You can ask the mirror where you take it from (and why not, all mirrors) to add it to their setup file. As an example, here's the configuration for the first mirror:

    mirrorlist:
      deuxpi: https://reseaulibre.deuxpi.ca/

The [[!iki plugins/mirrorlist]] plugin of course needs to be enabled.

# Merging back into the wiki

The final step is to make edits on the mirror reflect back to the master site. That way the mirror is not only for reading, but can also be edited, even when the master is offline or the network is separated.

To do this, the mirror needs to push back to the master, again using the gitpush plugin:

    git_push_to:
    - git://wiki.reseaulibre.ca/

This will ensure that commits done on the mirror will propagate back to the master.

[[!meta copyright="Copyright © 2011 Antoine Beaupré"]]

[[!meta license="""[[!toggle id="license" text="GFDL 1.2+"]][[!toggleable
id="license" text="Permission is granted to copy, distribute and/or modify this
document under the terms of the GNU Free Documentation License, Version 1.2 or
any later version published by the Free Software Foundation; with no Invariant
Sections, no Front-Cover Texts, and no Back-Cover Texts.  A copy of the license
is included in the section entitled [[GNU Free Documentation
License|meta/gfdl]]."]]"""]]
