[[!meta title="Batman on OpenWRT"]]

[[!toc levels=2]]

This guide will take you from a fresh OpenWRT installation up to a fully functional B.A.T.M.A.N. node.

# Installing OpenWRT

To install OpenWRT, you must [[flash your router|configuration/flashing]] with a recent version. The flashing instructions are out of the scope of this guide, but **we assume that you're installing trunk**, which provides batman version 2012.0.0. The stable version of OpenWRT, "backfire", provides an older version and is _not recommended_.

# Basic Network Configuration

Connect a cable from the LAN to your PC.
Set your PC to get an IP address automatically.
Get into the router with its default IP address.

    telnet 192.168.1.1

Activer la radio

    uci delete wireless.radio0.disabled

Set a custom name, in case you encouter other peers :-)

    uci set system.@system[0].hostname=batman-88

# Wireless Configuration

The wifi network should no longer belong in the 'lan' network bridge because that's not allowed in ad-hoc mode. We'll configure it later, so just remove it for now:

    uci delete wireless.@wifi-iface[0].network

Configure the wireless radio with Montreal mesh standards:

    uci set wireless.radio0.channel=6
    uci set wireless.@wifi-iface[0].mode=adhoc
    uci set wireless.@wifi-iface[0].ssid=mesh-mtl
    uci set wireless.@wifi-iface[0].bssid=02:51:48:72:03:11

Configure the wireless interface with a higher MTU to allow batman to decorate packets without causing fragmentation:

    uci set network.wlan0=interface
    uci set network.wlan0.ifname=wlan0
    uci set network.wlan0.proto=none
    uci set network.wlan0.mtu=1528

Configure the router LAN interface to match the network
of the home router this will be plugged into eventually.

    uci set network.lan.ipaddr=192.168.3.88
    uci set network.lan.gateway=192.168.3.1
    uci set network.lan.dns=192.168.3.1

Disable DHCP server on LAN, so as to not interfere with home router.

    uci set dhcp.lan.ignore=1

Écrire les changements et redémarrer

    uci commit
    reboot & exit

> *Note: only restarting network will not update the DHCP server.*

# Batman Installation

Disconnect the PC from the router and now connect both the
PC and the mesh router to the home router.
Re-connect to the router using its new IP address.

    telnet 192.168.3.88

Install B.A.T.M.A.N (the home router provides access to internet)

    opkg update
    opkg install kmod-batman-adv

> If your router has no internet access, or the operation freezes your router, or gives memory errors, you will have to install the `kmod-lib-crc16` and `kmod-batman-adv` modules by hand. See the [[Manual Package Installation|guides/openwrt+batman/manual-package-install]] help.

Le module `batman_adv` devrait maintenant être chargé:

    lsmod | grep batman

You should see: batctl 2012.0.0

    batctl -v

# Wireless Configuration

We have enabled wireless previously (see [[configuration/ad-hoc]] if you haven't). Now, verify that the wifi interface
is listed. If not, you may have flashed the wrong image!

    iwconfig


# Batman Configuration

Configuration de l'interface de batman. We're not assigning an IP address to `bat0` because we'll add it to the `lan` bridge.

    uci set network.bat0=interface
    uci set network.bat0.ifname=bat0
    uci set network.bat0.proto=none
    uci set network.bat0.mtu=1500

The 'lan' bridge should include bat0 as well as eth0:

    uci set network.lan.ifname="eth0 bat0"

(!) The above may be eth0.0 instead of eth0. For linksys it's eth0.0,
for ubiquity it's eth0. Look at the output of ifconfig to see what's
the eth0 interface.

Tell batman to use the wireless and the lan interfaces.

    uci set batman-adv.bat0.interfaces="wlan0 br-lan"

You're done! Commit the changes and reboot to test them.

    uci commit
    reboot & exit

# Testing

After a reboot, you should see `wlan0: active` and `br-lan: active` with this:

[[!format txt """
root@batman-88:/# brctl show
bridge name     bridge id               STP enabled     interfaces
br-lan          8000.00259c5e4457       no              eth0.0
                                                        bat0
root@batman-88:/# batctl if
wlan0: active
br-lan: active
"""]]
